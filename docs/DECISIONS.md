# 기술 결정 기록 (ADR)

## ADR-001: 프레임워크 선택

**날짜**: 2025-01-22

**결정**: Next.js (App Router) + TypeScript + Supabase

**이유**:
- Next.js App Router: 서버/클라이언트 컴포넌트 분리, API Routes 내장
- TypeScript: 타입 안정성, 코드 품질
- Supabase: PostgreSQL + Auth + RLS + Storage 통합 솔루션

**대안**:
- Remix + Prisma + 별도 Auth: 복잡성 증가
- SvelteKit: 팀 학습 비용

---

## ADR-002: Tool DB 미구축

**날짜**: 2025-01-22

**결정**: 별도 Tool DB를 구축하지 않고 정책/검증으로 무료 툴 사용 강제

**이유**:
- AI 도구 생태계가 빠르게 변화 → DB 유지보수 비용
- 프롬프트 레벨 규칙 + 키워드 검증으로 충분
- 정책 테이블 (금지어/예외) 확장 가능

**구현**:
1. 생성 규칙: 프롬프트에 무료/오픈소스 제약 명시
2. 검증: "무료 범위 표기" 누락 시 저장/FINAL 불가
3. 운영: FINAL 전 체크리스트 제공

---

## ADR-003: 컨설턴트 프로필 스냅샷

**날짜**: 2025-01-22

**결정**: 로드맵 버전 생성 시 배정 컨설턴트 프로필을 스냅샷으로 저장

**이유**:
- 버전 재현성 보장 (프로필 변경 시에도 당시 상태 유지)
- 감사/품질관리 목적
- 로드맵이 컨설턴트 역량 기반으로 생성되므로 연관성 보존

**구현**:
- `roadmap_versions.consultant_profile_snapshot` JSONB 컬럼

---

## ADR-004: 버전관리 정책

**날짜**: 2025-01-22

**결정**: DRAFT 무한 생성, FINAL 1개 유지, 덮어쓰기 금지

**이유**:
- 이력 추적 및 감사 가능
- 실수 방지 (덮어쓰기 금지)
- 스토리지 효율 (최신 FINAL만 저장)

**구현**:
- 새 FINAL 확정 시 기존 FINAL → ARCHIVED
- PDF/XLSX는 DB 데이터로 렌더링 (LLM 재호출 금지)

---

## ADR-005: RLS 기반 권한 제어

**날짜**: 2025-01-22

**결정**: Supabase RLS로 데이터베이스 레벨 권한 강제

**이유**:
- API 레벨 검증만으로는 보안 취약점 가능
- DB 레벨에서 강제하면 클라이언트 직접 접근도 차단
- Supabase에서 네이티브 지원

**구현**:
- 모든 테이블 RLS 활성화
- 헬퍼 함수로 역할/배정 상태 확인
- 서버에서도 세션/역할 이중 검증

---

## ADR-006: 매칭 알고리즘

**날짜**: 2025-01-22

**결정**: 규칙 기반 점수화 + 근거 제공

**이유**:
- 설명가능성 (왜 이 컨설턴트를 추천했는지)
- 운영자가 최종 판단하므로 근거 중요
- ML 모델보다 규칙 기반이 초기에 적합

**평가 기준**:
1. 업종 적합성
2. 전문분야 일치도
3. 역량 태그 매칭
4. 강의 레벨 적합성
5. 경력/가용성

---

## ADR-007: 40시간 상한

**날짜**: 2025-01-22

**결정**: 과정 1개 단위로 ≤40시간 강제

**이유**:
- 기획서 명시 요구사항
- PBL 최적 과정도 합계 ≤40h
- 검증 로직으로 강제

**구현**:
- 생성 시 프롬프트에 제약 명시
- 저장 전 검증 (time_limit_validated)
- 위반 시 저장/FINAL 불가

---

## ADR-008: 모바일 반응형 (NxM 로드맵)

**날짜**: 2025-01-22

**결정**: 모바일에서는 레벨 탭 + 카드 리스트로 변환

**이유**:
- NxM 테이블은 모바일에서 보기 어려움
- 기획서에 옵션 B (레벨 탭) 제시
- 사용성 우선

**구현**:
- 데스크톱: NxM 테이블
- 태블릿/모바일: 초/중/고급 탭 → 행별 카드

---

## ADR-009: 감사로그 설계

**날짜**: 2025-01-22

**결정**: 구조화된 감사로그 테이블 + 서버에서만 삽입

**이유**:
- 감사/컴플라이언스 요구
- 클라이언트에서 조작 방지
- 필터/검색 용이

**필수 이벤트**:
- 사용자 승인/정지
- 케이스 생성/수정
- 자가진단 입력/수정
- 매칭/배정/변경
- 로드맵 생성/수정/FINAL/ARCHIVE
- 다운로드

---

## ADR-010: 쿼터 관리

**날짜**: 2025-01-22

**결정**: LLM 호출에만 쿼터 적용, KST 기준 리셋

**이유**:
- 비용 통제 목적
- 조회/다운로드는 쿼터 비적용
- 운영 편의상 KST 기준

**구현**:
- usage_metrics 테이블로 집계
- user_quotas 테이블로 상한 관리
- 초과 시 생성/수정 차단
